# Resource Pack Backporter

transforms modern minecraft resource packs (1.21.4+) to work with older versions (1.21.1) by converting new conditional item model formats to legacy-compatible alternatives.

## features

- **conditional compiler architecture**: converts 1.21.4+ conditional selectors to pommel predicates and cit properties
- **display context handling**: maps display contexts (gui, ground, held, offhand) to pommel predicates
- **enchanted book support**: generates cit properties for individual enchantments with proper texture mapping
- **3d model integration**: preserves and references custom 3d models in backported overrides
- **template protection**: prevents corruption of 3d template files during processing
- **model compatibility fixes**: automatically fixes zero-thickness elements and invalid parents

## usage

```bash
# direct usage
bun run tools/backporter/index.ts <input-dir> [output-dir]

# via unified cli
bun run tools/index.ts backport <input-dir> [output-dir]

# via package script
bun run backport <input-dir> [output-dir]
```

## examples

```bash
# backport a resource pack
bun run backport ./my-pack ./my-pack-backported

# backport to default output location
bun run backport ./my-pack
# outputs to: dist/↺-my-pack
```

## architecture

the backporter uses a modular conditional compiler architecture:

### core components

- **conditional compiler**: main orchestrator that processes 1.21.4+ conditional selectors
- **strategy selection**: analyzes item components to choose optimal backport strategy
- **file management**: handles input/output operations with conflict resolution
- **handlers**: process specific item components (display context, enchantments, etc.)
- **writers**: generate output files (pommel models, cit properties, vanilla models)
- **mergers**: combine multiple write requests for the same file
- **postprocessors**: apply compatibility fixes and template protection

### strategies

1. **pure pommel**: for items with only display context variations
2. **pure cit**: for items with only nbt-based variations (enchantments)
3. **combined cit + pommel**: for enchanted books (cit for enchantment selection, pommel for contexts)
4. **simple copy**: for items with no conditional logic

## supported transformations

### display context mapping

- `gui`, `fixed` → no pommel predicate (default state)
- `ground` → `pommel:is_ground: 1`
- `firstperson_righthand`, `thirdperson_righthand` → `pommel:is_held: 1`
- `firstperson_lefthand`, `thirdperson_lefthand` → `pommel:is_offhand: 1`

### enchanted book processing

- generates individual cit properties for each enchantment level
- creates pommel models with proper 3d model references
- handles curse enchantment name mapping
- supports both single and multi-level enchantments

### model compatibility

- fixes zero-thickness elements in 3d models
- removes invalid `builtin/entity` parents
- protects template files from corruption
- preserves animated model properties

## testing

```bash
# run all backporter tests
bun test tools/backporter/src/

# run specific test suites
bun test tools/backporter/src/index.test.ts
bun test tools/backporter/src/integration.test.ts
bun test tools/backporter/src/books-regression.test.ts
```

## configuration

the backporter automatically detects pack structure and applies appropriate strategies. no configuration files needed.

## limitations

- requires pommel mod for predicate support in target minecraft version
- 3d models must be pre-created (not generated by backporter)
- some advanced 1.21.4+ features may not have direct 1.21.1 equivalents

## output structure

```
output-pack/
├── pack.mcmeta                    # updated with backport attribution
├── assets/minecraft/
│   ├── models/item/
│   │   ├── book.json             # pommel overrides for regular books
│   │   ├── enchanted_book.json   # base model for enchanted books
│   │   └── enchanted_books/      # individual enchantment models
│   │       ├── sharpness_1.json
│   │       └── ...
│   └── optifine/cit/             # cit properties for enchantments
│       ├── sharpness_1.properties
│       └── ...
└── ...
```
